# config/packages/security.yaml
security:
    # 1. HASHERS (Mismo que ten铆as)
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'

    # 2. PROVIDERS (Define d贸nde buscar usuarios)
    providers:
        # Proveedor basado en tu entidad Usuario
        app_user_provider:
            entity:
                class: App\Entity\Usuario
                property: username # Campo utilizado para el login (username o email)

    # 3. FIREWALLS (Define c贸mo se maneja la seguridad en diferentes rutas)
    firewalls:
        dev:
            # Deshabilita la seguridad para herramientas de desarrollo
            pattern: ^/(_profiler|_wdt|assets|build)/
            security: false

        api:
            #  NUEVO FIREWALL PARA LA API
            # Captura todas las rutas que empiecen por /api
            pattern: ^/api
            stateless: true # Es una API, no usa sesiones (requerido para JWT)
            provider: app_user_provider
            
            # A. INTERCEPTOR DE LOGIN (Captura POST a /api/login_check)
            json_login:
                check_path: /api/login_check # URL que el frontend usa para enviar credenciales
                username_path: username       # Clave JSON para el usuario
                password_path: password       # Clave JSON para la contrase帽a
                
                # Handlers proporcionados por LexikJWTAuthenticationBundle
                success_handler: lexik_jwt_authentication.handler.authentication_success
                failure_handler: lexik_jwt_authentication.handler.authentication_failure

            # B. AUTENTICACIN JWT (Maneja las peticiones subsiguientes)
            jwt: ~ # Activa el listener para validar el token JWT en las cabeceras

        # Puedes dejar 'main' si tienes rutas tradicionales, pero la API lo ignora
        main:
            lazy: true
            provider: app_user_provider
            # ... (opcional: form_login, si tienes otras rutas web)

    # 4. ACCESS CONTROL (Define qu茅 roles pueden acceder a qu茅 rutas)
    access_control:
        # Permite el acceso an贸nimo a la ruta de login para poder autenticarse
        - { path: ^/api/login_check, roles: PUBLIC_ACCESS } 
        - { path: ^/api, roles: PUBLIC_ACCESS, methods: [OPTIONS] }
        # Protege el resto de las rutas de la API, requiriendo autenticaci贸n completa
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY } 

when@test:
    security:
        password_hashers:
            Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
                algorithm: auto
                cost: 4
                time_cost: 3
                memory_cost: 10